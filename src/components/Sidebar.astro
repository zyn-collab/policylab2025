---
import { getCollection } from 'astro:content';

// Load TOC data
let tocData = { sections: [] };
try {
  const tocModule = await import('../data/toc.json');
  tocData = tocModule.default;
} catch (e) {
  // TOC not yet generated
}

const currentPath = Astro.url.pathname;
---

<aside class="sidebar">
  <div class="sidebar-header">
    <h2 class="sidebar-title">
      <a href="/" style="color: inherit;">
        Building Blocks<br />
        Collected Briefs & Publications, 2024-25
      </a>
    </h2>
    <p class="sidebar-byline">By Public Policy Lab</p>
    <p class="sidebar-description">
      [DRAFT STAGE - TO BE OFFICIALLY RELEASED EST. JAN 2026] This digital publication compiles some of the work developed by Public Policy Lab over the past 18 months. We publish this along with brand-new material thematically binding these briefs together, as well as further information about our work.
    </p>
    <input
      type="text"
      class="search-box"
      placeholder="Search..."
      id="sidebar-search"
    />
    <button class="dark-mode-toggle" id="dark-mode-toggle">
      Toggle Dark Mode
    </button>
  </div>

  <nav class="sidebar-nav" id="sidebar-nav">
    {(() => {
      let globalChapterNumber = 0;
      return tocData.sections.map((section) => (
        <div class="nav-section">
          <div class="nav-section-header">
            <span>{section.title}</span>
            <span class="nav-section-toggle">â–¼</span>
          </div>
          <ul class="nav-chapter-list">
            {section.chapters.map((chapter) => {
              globalChapterNumber++;
              return (
                <li class="nav-chapter-item">
                  <a
                    href={`/chapter/${chapter.slug}`}
                    class:list={['nav-chapter-link', { active: currentPath === `/chapter/${chapter.slug}` }]}
                  >
                    {globalChapterNumber}. {chapter.title}
                  </a>
                </li>
              );
            })}
          </ul>
        </div>
      ));
    })()}
  </nav>
</aside>

<script>
  // Dark mode toggle
  const toggle = document.getElementById('dark-mode-toggle');
  const html = document.documentElement;

  // Load saved preference
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    html.classList.add('dark');
  }

  toggle?.addEventListener('click', () => {
    html.classList.toggle('dark');
    const isDark = html.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  });

  // Collapsible sections
  document.querySelectorAll('.nav-section-header').forEach(header => {
    header.addEventListener('click', () => {
      const section = header.closest('.nav-section');
      section?.classList.toggle('collapsed');
    });
  });

  // Search functionality
  const searchBox = document.getElementById('sidebar-search') as HTMLInputElement;
  const nav = document.getElementById('sidebar-nav');

  searchBox?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();
    const sections = nav?.querySelectorAll('.nav-section');

    sections?.forEach(section => {
      const sectionEl = section as HTMLElement;
      const chapters = section.querySelectorAll('.nav-chapter-link');
      let hasVisibleChapter = false;

      chapters.forEach(chapter => {
        const chapterEl = chapter as HTMLElement;
        const text = chapterEl.textContent?.toLowerCase() || '';
        const matches = text.includes(query);
        chapterEl.style.display = matches ? 'block' : 'none';
        if (matches) hasVisibleChapter = true;
      });

      // Show section if it has visible chapters or if search is empty
      if (query === '') {
        sectionEl.style.display = 'block';
        sectionEl.classList.remove('collapsed');
      } else {
        sectionEl.style.display = hasVisibleChapter ? 'block' : 'none';
        if (hasVisibleChapter) {
          sectionEl.classList.remove('collapsed');
        }
      }
    });
  });
</script>
